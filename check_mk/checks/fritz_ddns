#!/usr/bin/env python
#

def inventory_fritz_ddns(checkname, info):
    ret = []
    if len(info) > 1:
        for line in info:
            # if we don't have any upgrades listed, the line list
            # will only contain one element, eg. "upgrades\n"
            if len(line) < 3:
                continue
            name = line[0]
            ret.append( (name, {}) )
    return ret

def check_fritz_ddns(item, params, info):
    # hostname, ipaddress are defined by check_mk
    level   = 0 # 0:OK, 1:WARNING 2:CRITICAL, 3: UNKNOWN
    msg = None
    perfdata = []
    details = []
    data = {}

    for line in info:
        # if we don't have any upgrades listed, the line list
        # will only contain one element, eg. "upgrades\n"
        line_len = len(line)
        if line_len < 5:
            continue
        (name, status, ip, wan_ip, error_msg) = line[:5]
        status = saveint(status)
        data[name] = (ip, wan_ip, status, error_msg)

    if item in data:
        (ip, wan_ip, status, error_msg) = data[item]
        #print('item %s: %s' % (item, data[item] ))
        if status == 0:
            level = 0
            details.append('%s matches %s' % (ip, item))
        elif status == 3: #unknown
            if not wan_ip:
                level = 0 # report as ok, to avoid error during re-connecting phase
                details.append('%s is OK (no internet connection)' % (item))
            elif not ip:
                level = 2
                details.append('No address for %s (should be %s) (%s)' % (item, wan_ip, error_msg))
            else:
                level = 1
                details.append('%s!=%s does not match %s' % (ip, wan_ip, item))
        else:
            level = 1
            details.append('%s!=%s does not match %s (%s)' % (ip, wan_ip, item, error_msg))

    else:
        level = 3
        details.append('%s not found in agent data' % (item))

    # Construct a the status message.
    if level == 0:
        msg = "OK - %s" % (','.join(details))
    elif level == 1:
        msg = "WARN - %s" % (','.join(details))
    elif level == 2:
        msg = "CRIT - %s" % (','.join(details))
    elif level == 3:
        msg = "UNKNOWN - %s" % (','.join(details))
    return (level, msg, perfdata)

# declare the check to Check_MK.
check_info['fritz_ddns'] = {
    'check_function':            check_fritz_ddns,
    'inventory_function':        inventory_fritz_ddns,
    'service_description':       'Dynamic DNS',
    'has_perfdata':              True,
}

